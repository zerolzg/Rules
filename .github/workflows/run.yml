name: Update Rules & Lists

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    env:
      # 数据源 URLs (已修复：删除末尾空格)
      APNIC_URL: "https://ftp.apnic.net/stats/apnic/delegated-apnic-latest"
      LOYALSOLDIER_REJECT_URL: "https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/reject-list.txt"

      # 输出文件路径
      DIR_SURGE: "Surge/Surge 3/Provider"
      DIR_CLASH: "Clash/Provider"
      FILE_IP_SURGE: "Domestic IPs.list"
      FILE_IP_CLASH: "Domestic IPs.yaml"
      FILE_REJECT_CLASH: "AdBlock.yaml"

      # 临时文件列表 (空格分隔)
      TEMP_FILES: "delegated-apnic-latest raw_ips.txt temp_reject_payload.txt"

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Directories
        run: |
          mkdir -p "${{ env.DIR_SURGE }}"
          mkdir -p "${{ env.DIR_CLASH }}"

      - name: Generate China IP Lists
        id: gen_ips
        run: |
          set -euo pipefail
          echo "Downloading APNIC data..."
          wget -q -O delegated-apnic-latest "${{ env.APNIC_URL }}"

          echo "Processing IPv4/IPv6 CIDR..."
          awk -F '|' '
            $2 == "CN" && $3 == "ipv4" {
              cidr = 32 - log($5)/log(2);
              printf "%s/%d\n", $4, cidr
            }
            $2 == "CN" && $3 == "ipv6" {
              printf "%s/%s\n", $4, $5
            }
          ' delegated-apnic-latest > raw_ips.txt

          echo "# > Domestic IPs" > "${{ env.DIR_SURGE }}/${{ env.FILE_IP_SURGE }}"
          awk '{print "IP-CIDR,"$1",no-resolve"}' raw_ips.txt >> "${{ env.DIR_SURGE }}/${{ env.FILE_IP_SURGE }}"

          echo "payload:" > "${{ env.DIR_CLASH }}/${{ env.FILE_IP_CLASH }}"
          awk '{ printf "  - '\''%s'\''\n", $1 }' raw_ips.txt >> "${{ env.DIR_CLASH }}/${{ env.FILE_IP_CLASH }}"

          echo "IP lists generated successfully."

      - name: Generate Reject Lists
        id: gen_reject
        run: |
          set -euo pipefail
          echo "Downloading Loyalsoldier reject list..."
          curl -sSL "${{ env.LOYALSOLDIER_REJECT_URL }}" | grep -Ev "^(regexp|keyword):" | perl -ne '/^(domain:|full:)?([-_a-zA-Z0-9]+(\.[-_a-zA-Z0-9]+)*)/ && print "  - |+.$2|\n"' | sed "s/|/'/g" > temp_reject_payload.txt

          echo "payload:" > "${{ env.DIR_CLASH }}/${{ env.FILE_REJECT_CLASH }}"
          cat temp_reject_payload.txt >> "${{ env.DIR_CLASH }}/${{ env.FILE_REJECT_CLASH }}"

          echo "Reject list generated successfully."

      - name: Cleanup Temporary Files
        run: |
          echo "Cleaning up temporary files..."

          for file in ${{ env.TEMP_FILES }}; do
            if [ -f "$file" ]; then
              rm -f "$file"
              echo "  Removed: $file"
            fi
          done

          rm -f *.txt *.tmp 2>/dev/null || true

          if [ ! -f ".gitignore" ]; then
            echo "# Auto-generated by GitHub Actions" > .gitignore
          fi

          grep -q "^delegated-apnic-latest$" .gitignore || echo "delegated-apnic-latest" >> .gitignore
          grep -q "^raw_ips.txt$" .gitignore || echo "raw_ips.txt" >> .gitignore
          grep -q "^temp_.*" .gitignore || echo "temp_*" >> .gitignore
          grep -q "^*.tmp$" .gitignore || echo "*.tmp" >> .gitignore

          echo "Cleanup completed."

      # ========== 关键修复：Commit 步骤 ==========
      - name: Commit and Push Changes
        id: commit_step
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Action"

          # 添加目标目录和 .gitignore
          git add "${{ env.DIR_SURGE }}/" "${{ env.DIR_CLASH }}/" .gitignore

          if ! git diff --cached --quiet; then
            git commit -m "chore: update rules $(date +%Y-%m-%d)"
            git push
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "No changes detected."
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      # ========== 关键修复：Purge URL 空格 ==========
      - name: Purge jsDelivr Cache
        if: steps.commit_step.outputs.has_changes == 'true'
        run: |
          echo "Starting jsDelivr cache purge..."

          FILES=(
            "${{ env.DIR_CLASH }}/${{ env.FILE_IP_CLASH }}"
            "${{ env.DIR_SURGE }}/${{ env.FILE_IP_SURGE }}"
            "${{ env.DIR_CLASH }}/${{ env.FILE_REJECT_CLASH }}"
          )

          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"

          for FILE in "${FILES[@]}"; do
            ENCODED_FILE="${FILE// /%20}"
            PURGE_URL="https://purge.jsdelivr.net/gh/${REPO}@${BRANCH}/${ENCODED_FILE}"
            echo "Purging: ${PURGE_URL}"
            curl -s -o /dev/null -w "  Status: %{http_code}\n" "${PURGE_URL}" || true
            sleep 1
          done

          echo "Cache purge requests completed."
